<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>VLM-R1æºç è§£æ | Liuyi Wen's Blog</title><meta name="author" content="Liuyi Wen"><meta name="copyright" content="Liuyi Wen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="VLM-R1åŸºäºTRLæ¡†æ¶ã€‚ GROPæ–¹æ³• GRPO æ˜¯ä¸€ç§åœ¨çº¿å­¦ä¹ ç®—æ³•ï¼Œå®ƒé€šè¿‡ä½¿ç”¨è®­ç»ƒæ¨¡å‹æœ¬èº«åœ¨è®­ç»ƒæœŸé—´ç”Ÿæˆçš„æ•°æ®è¿›è¡Œè¿­ä»£æ”¹è¿›ã€‚å…¶ç†å¿µæ˜¯ï¼šæœ€å¤§ç¨‹åº¦åˆ©ç”¨ç”Ÿæˆè¡¥å…¨ï¼ŒåŒæ—¶ç¡®ä¿æ¨¡å‹å§‹ç»ˆæ¥è¿‘å‚è€ƒç­–ç•¥ã€‚ åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼šç”Ÿæˆè¡¥å…¨ã€è®¡ç®—å¥–åŠ±ã€ä¼°è®¡KLæ•£åº¦ã€è®¡ç®—æŸå¤±ã€‚  è¦ç‚¹ å¼•å…¥criticï¼šä½¿ç”¨é¢„æµ‹baselineæ”¹è¿›å¥–åŠ± ä½¿ç”¨ç»å¯¹å¥–åŠ±ï¼Œå•çº¯æ¯”è¾ƒå¤§å°ï¼Œä¼šå¯¼è‡´ï¼šå¥–åŠ±æ³¢åŠ¨å¤§ï¼Œä»¥åŠå¯¹éƒ¨åˆ†æ”¹è¿›çš„æ¿€åŠ±ä¸è¶³ï¼›å› æ­¤å¼•å…¥Cr"><meta property="og:type" content="article"><meta property="og:title" content="VLM-R1æºç è§£æ"><meta property="og:url" content="http://wenliuyi.github.io/posts/ae5287f0.html"><meta property="og:site_name" content="Liuyi Wen&#39;s Blog"><meta property="og:description" content="VLM-R1åŸºäºTRLæ¡†æ¶ã€‚ GROPæ–¹æ³• GRPO æ˜¯ä¸€ç§åœ¨çº¿å­¦ä¹ ç®—æ³•ï¼Œå®ƒé€šè¿‡ä½¿ç”¨è®­ç»ƒæ¨¡å‹æœ¬èº«åœ¨è®­ç»ƒæœŸé—´ç”Ÿæˆçš„æ•°æ®è¿›è¡Œè¿­ä»£æ”¹è¿›ã€‚å…¶ç†å¿µæ˜¯ï¼šæœ€å¤§ç¨‹åº¦åˆ©ç”¨ç”Ÿæˆè¡¥å…¨ï¼ŒåŒæ—¶ç¡®ä¿æ¨¡å‹å§‹ç»ˆæ¥è¿‘å‚è€ƒç­–ç•¥ã€‚ åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼šç”Ÿæˆè¡¥å…¨ã€è®¡ç®—å¥–åŠ±ã€ä¼°è®¡KLæ•£åº¦ã€è®¡ç®—æŸå¤±ã€‚  è¦ç‚¹ å¼•å…¥criticï¼šä½¿ç”¨é¢„æµ‹baselineæ”¹è¿›å¥–åŠ± ä½¿ç”¨ç»å¯¹å¥–åŠ±ï¼Œå•çº¯æ¯”è¾ƒå¤§å°ï¼Œä¼šå¯¼è‡´ï¼šå¥–åŠ±æ³¢åŠ¨å¤§ï¼Œä»¥åŠå¯¹éƒ¨åˆ†æ”¹è¿›çš„æ¿€åŠ±ä¸è¶³ï¼›å› æ­¤å¼•å…¥Cr"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://wenliuyi.github.io/img/butterfly-icon.png"><meta property="article:published_time" content="2025-03-28T02:45:42.000Z"><meta property="article:modified_time" content="2025-05-20T03:46:28.000Z"><meta property="article:author" content="Liuyi Wen"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://wenliuyi.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "VLM-R1æºç è§£æ",
  "url": "http://wenliuyi.github.io/posts/ae5287f0.html",
  "image": "http://wenliuyi.github.io/img/butterfly-icon.png",
  "datePublished": "2025-03-28T02:45:42.000Z",
  "dateModified": "2025-05-20T03:46:28.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Liuyi Wen",
      "url": "http://wenliuyi.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://wenliuyi.github.io/posts/ae5287f0.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{const e={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:e,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const t=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=t,btf.activateLightMode=o;const a=e.get("theme");"dark"===a?t():"light"===a&&o();const n=e.get("aside-status");void 0!==n&&document.documentElement.classList.toggle("hide-aside","hide"===n);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"VE36MEFVE6",apiKey:"f9b9ca5a3cdb9455658600dba6ae7706",indexName:"hexo-algolia indexing key",hitsPerPage:6,languages:{input_placeholder:"æœç´¢æ–‡ç« ",hits_empty:"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}",hits_stats:"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œè€—æ—¶ ${time} æ¯«ç§’"}},localSearch:void 0,translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"å¤åˆ¶æˆåŠŸ",error:"å¤åˆ¶å¤±è´¥",noSupport:"æµè§ˆå™¨ä¸æ”¯æŒ"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰",month:"ä¸ªæœˆå‰"},copyright:void 0,lightbox:"null",Snackbar:void 0,infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"åŠ è½½æ›´å¤š"},isPhotoFigcaption:!1,islazyloadPlugin:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"VLM-R1æºç è§£æ",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Liuyi Wen's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">VLM-R1æºç è§£æ</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div></div></nav><div id="post-info"><h1 class="post-title">VLM-R1æºç è§£æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-03-28T02:45:42.000Z" title="å‘è¡¨äº 2025-03-28 10:45:42">2025-03-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-05-20T03:46:28.000Z" title="æ›´æ–°äº 2025-05-20 11:46:28">2025-05-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Introduction-to-AI/">Introduction to AI</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>VLM-R1åŸºäºTRLæ¡†æ¶ã€‚</p><h2 id="gropæ–¹æ³•">GROPæ–¹æ³•</h2><p>GRPO æ˜¯ä¸€ç§åœ¨çº¿å­¦ä¹ ç®—æ³•ï¼Œå®ƒé€šè¿‡ä½¿ç”¨è®­ç»ƒæ¨¡å‹æœ¬èº«åœ¨è®­ç»ƒæœŸé—´ç”Ÿæˆçš„æ•°æ®è¿›è¡Œè¿­ä»£æ”¹è¿›ã€‚å…¶ç†å¿µæ˜¯ï¼šæœ€å¤§ç¨‹åº¦åˆ©ç”¨ç”Ÿæˆè¡¥å…¨ï¼ŒåŒæ—¶ç¡®ä¿æ¨¡å‹å§‹ç»ˆæ¥è¿‘å‚è€ƒç­–ç•¥ã€‚</p><p>åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼šç”Ÿæˆè¡¥å…¨ã€è®¡ç®—å¥–åŠ±ã€ä¼°è®¡KLæ•£åº¦ã€è®¡ç®—æŸå¤±ã€‚ <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="/posts/ae5287f0/image.png"></p><h3 id="è¦ç‚¹">è¦ç‚¹</h3><h4 id="å¼•å…¥criticä½¿ç”¨é¢„æµ‹baselineæ”¹è¿›å¥–åŠ±">å¼•å…¥criticï¼šä½¿ç”¨é¢„æµ‹baselineæ”¹è¿›å¥–åŠ±</h4><p>ä½¿ç”¨ç»å¯¹å¥–åŠ±ï¼Œå•çº¯æ¯”è¾ƒå¤§å°ï¼Œä¼šå¯¼è‡´ï¼šå¥–åŠ±æ³¢åŠ¨å¤§ï¼Œä»¥åŠå¯¹éƒ¨åˆ†æ”¹è¿›çš„æ¿€åŠ±ä¸è¶³ï¼›å› æ­¤<strong>å¼•å…¥Criticï¼šä½¿ç”¨â€œé¢„æµ‹baselineâ€æ¥æ”¹è¿›å¥–åŠ±</strong></p><p>å¯¹äºç»™å®šçŠ¶æ€(<span class="math inline">\(s_t\)</span>)å’ŒåŠ¨ä½œ(<span class="math inline">\(o_t\)</span>)ï¼Œè¯¥baselineä¸º<strong>ä»·å€¼å‡½æ•°<span class="math inline">\((V_\psi(s))\)</span></strong>ï¼›è®­ç»ƒç›®æ ‡ç”±å•çº¯çš„rewardï¼Œè½¬ä¸ºè¶…è¿‡è¯¥baselineçš„ç¨‹åº¦ï¼Œç”±ä¼˜åŠ¿å‡½æ•°è¡¨ç¤ºä¸ºï¼š <span class="math display">\[ A_t=r_t-V_\psi(s_t) \]</span> å³è®­ç»ƒä¸­ä¼˜åŒ–å†…å®¹ä¸ºï¼š <span class="math display">\[ \mathcal{J}_{adv}(\theta)=\mathbb{E}[A(o)] \\ where A(o)=r(o)-V_\psi(o) \]</span> é€šè¿‡å‡å»baselineï¼Œé™ä½äº†è®­ç»ƒä¸­çš„æ–¹å·®ï¼Œä¸ºè¶…å‡ºé¢„æœŸçš„åŠ¨ä½œæä¾›æ›´é«˜çš„æ¢¯åº¦ä¿¡å·ï¼›å¹¶å¯¹æœªè¾¾æ ‡çš„åŠ¨ä½œè¿›è¡Œæƒ©ç½šã€‚</p><h4 id="æ·»åŠ è£å‰ªå’Œæœ€å°å€¼æ“ä½œé˜²æ­¢è¿‡åº¦æ›´æ–°">æ·»åŠ è£å‰ªå’Œæœ€å°å€¼æ“ä½œï¼šé˜²æ­¢è¿‡åº¦æ›´æ–°</h4><p>é€‚åº¦æ§åˆ¶å­¦ä¹ ç­–ç•¥çš„æ›´æ–°ç¨‹åº¦ï¼šè‹¥å•æ¬¡æ›´æ–°å¤ªå¤šï¼Œåˆ™å¯èƒ½èµ°å‘æç«¯å€¼ï¼›è‹¥å•æ¬¡æ›´æ–°å¤ªå°‘ï¼Œåˆ™åŠ¨åŠ›ä¸è¶³ã€‚åº”æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚</p><p>åœ¨Proximal Policy Optimization (PPO)ä¸­æœ€å¤§åŒ–ä»¥ä¸‹ç›®æ ‡å‡½æ•°ï¼š <span class="math display">\[ \mathcal{J}_{adv}(\theta)=\mathbb{E}[q\sim P(Q), o\sim\pi_{\theta_{old}}(O|q)]\frac{1}{|o|}\sum_{t=1}^{|o|}\min[r_t(\theta)A_t, clip(r_t(\theta),1-\epsilon,1+\epsilon)A_t] \]</span> å…¶ä¸­ï¼š <span class="math display">\[ r_t(\theta)=\frac{\pi_{\theta}(o_t|q,o_{&lt;t})}{\pi_{\theta_{old}}(o_t|q,o_{&lt;t})} \]</span> <span class="math inline">\(\pi_{\theta}\)</span>å’Œ<span class="math inline">\(\pi_{\theta_{old}}\)</span>åˆ†åˆ«æ˜¯ï¼šå½“å‰ç­–ç•¥æ¨¡å‹ã€æ—§ç­–ç•¥æ¨¡å‹ï¼›<span class="math inline">\(q\)</span>å’Œ<span class="math inline">\(o\)</span>æ˜¯ä»é—®é¢˜æ•°æ®é›†å’Œæ—§ç­–ç•¥<span class="math inline">\(\pi_{\theta_{old}}\)</span>ä¸­é‡‡æ ·çš„é—®é¢˜å’Œè¾“å‡ºï¼›è¶…å‚æ•°<span class="math inline">\(\epsilon\)</span>ç”¨äºç¨³å®šè®­ç»ƒè¿‡ç¨‹ï¼›ä¼˜åŠ¿<span class="math inline">\(A_i\)</span>é€šè¿‡å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ï¼ˆGAEï¼‰è®¡ç®—ã€‚</p><h4 id="é˜²æ­¢ä½œå¼Šå’Œæç«¯ç­–ç•¥ä½¿ç”¨klæ•£åº¦">é˜²æ­¢ä½œå¼Šå’Œæç«¯ç­–ç•¥ï¼šä½¿ç”¨KLæ•£åº¦</h4><p>å¦‚æœåªä¸“æ³¨äºæœ€å¤§åŒ–ç›®æ ‡å‡½æ•°ï¼Œå¯èƒ½ä¼šé‡‡ç”¨å¯ç–‘æ‰‹æ®µï¼Œå³ç”Ÿæˆæœ‰å®³æˆ–è™šå‡å†…å®¹ï¼Œä»¥äººä¸ºæé«˜æŸäº›å¥–åŠ±æŒ‡æ ‡ã€‚ä¸ºäº†å‡è½»å¯¹å¥–åŠ±æ¨¡å‹çš„è¿‡åº¦ä¼˜åŒ–ï¼Œæ ‡å‡†æ–¹æ³•æ˜¯ï¼šåœ¨æ¯ä¸ªæ ‡è®°çš„å¥–åŠ±ä¸­ï¼Œ<strong>æ·»åŠ ä¸€ä¸ªæ¥è‡ªå‚è€ƒæ¨¡å‹ï¼ˆåˆå§‹ç­–ç•¥ï¼‰çš„æ¯ä¸ªæ ‡è®°çš„KLæƒ©ç½š</strong>ï¼Œå³ï¼š <span class="math display">\[ r_t=r_\varphi(q,o_{\leq t})-\beta\log\frac{\pi_\theta(o_t|q,o_{&lt;t})}{\pi_{ref}(o_t|q,o_{&lt;t})} \]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(r\)</span>æ˜¯å¥–åŠ±æ¨¡å‹ï¼Œ<span class="math inline">\(\pi_{ref}\)</span>æ˜¯å‚è€ƒæ¨¡å‹ï¼Œé€šå¸¸æ˜¯åˆå§‹çš„ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰æ¨¡å‹ï¼Œè€Œ<span class="math inline">\(\beta\)</span>æ˜¯KLæƒ©ç½šé¡¹çš„ç³»æ•°ã€‚</p><p>ç„¶è€Œï¼ŒPPO ä¸­çš„<strong>Criticï¼ˆå€¼å‡½æ•°ï¼‰é€šå¸¸æ˜¯ä¸€ä¸ªä¸Actorï¼ˆç­–ç•¥æ¨¡å‹ï¼‰å¤§å°ç›¸å½“çš„æ¨¡å‹</strong>ï¼Œè¿™å¸¦æ¥äº†æ˜¾è‘—çš„å†…å­˜å’Œè®¡ç®—è´Ÿæ‹…ï¼›æ­¤å¤–ï¼Œåœ¨ LLMs çš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒCriticåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¢«ç”¨ä½œä¼˜åŠ¿è®¡ç®—ä¸­çš„Baselineï¼Œä½†é€šå¸¸åªæœ‰æœ€åä¸€ä¸ª token ä¼šè¢«å¥–åŠ±æ¨¡å‹èµ‹äºˆå¥–åŠ±åˆ†æ•°ï¼Œè¿™å¯èƒ½ä½¿å¾—Criticçš„è®­ç»ƒå˜å¾—å¤æ‚ã€‚</p><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæå‡ºäº† Group Relative Policy Optimization (GRPO)ï¼Œä¸å†éœ€è¦åƒPPOé‚£æ ·åŠ å…¥é¢å¤–çš„Criticè¿‘ä¼¼ï¼Œè€Œæ˜¯<strong>ç›´æ¥ä½¿ç”¨å¤šä¸ªé‡‡æ ·è¾“å‡ºçš„å¹³å‡å¥–åŠ±ä½œä¸ºBaseline</strong>ï¼Œæ˜¾è‘—å‡å°‘äº†è®­ç»ƒèµ„æºçš„ä½¿ç”¨ã€‚</p><p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="/posts/ae5287f0/image-2.png"></p><p>å¯¹äºæ¯ä¸ªé—®é¢˜<span class="math inline">\(i\)</span>ï¼ŒGRPOä»æ—§ç­–ç•¥<span class="math inline">\(\pi_{\theta_{old}}\)</span>ä¸­ï¼Œé‡‡æ ·å‡ºä¸€ç»„è¾“å‡º{<span class="math inline">\(i_1\)</span>,...,<span class="math inline">\(i_A\)</span>}ï¼Œé€šè¿‡æœ€å¤§åŒ–ä»¥ä¸‹ç›®æ ‡å‡½æ•°ä¼˜åŒ–ç­–ç•¥æ¨¡å‹ï¼š <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="/posts/ae5287f0/image-3.png"></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(\epsilon\)</span> å’Œ <span class="math inline">\(\beta\)</span> æ˜¯è¶…å‚æ•°ï¼Œ<span class="math inline">\(\hat{A}_{i,t}\)</span>â€‹ æ˜¯åŸºäºç»„å†…å¥–åŠ±çš„ç›¸å¯¹ä¼˜åŠ¿ä¼°è®¡ã€‚</p><p>ä¸ PPO ä¸åŒï¼ŒGRPOï¼š 1. ç›´æ¥ä½¿ç”¨å¥–åŠ±æ¨¡å‹çš„è¾“å‡ºæ¥ä¼°è®¡baselineï¼Œé¿å…äº†è®­ç»ƒä¸€ä¸ªå¤æ‚çš„Criticï¼› 2. ç›´æ¥åœ¨æŸå¤±å‡½æ•°ä¸­åŠ å…¥ç­–ç•¥æ¨¡å‹å’Œå‚è€ƒæ¨¡å‹ä¹‹é—´çš„ KL æ•£åº¦æ¥æ­£åˆ™åŒ–ï¼Œè€Œä¸æ˜¯åœ¨å¥–åŠ±ä¸­åŠ å…¥ KL æƒ©ç½šé¡¹ï¼Œä»è€Œç®€åŒ–äº†è®­ç»ƒè¿‡ç¨‹ã€‚</p><p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="/posts/ae5287f0/image-4.png"></p><p>ä½¿ç”¨ä¸‹é¢çš„æ— åä¼°è®¡æ¥ä¼°è®¡ KL æ•£åº¦ï¼š <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="/posts/ae5287f0/image-5.png"></p><p>GRPOæ ¸å¿ƒæ€æƒ³ï¼š 1. æ— éœ€ä¸º Critic è®¾ç½®å•ç‹¬çš„ä»·å€¼ç½‘ç»œï¼› 2. å¯¹åŒä¸€é—®é¢˜æˆ–çŠ¶æ€ï¼Œä»æ—§ç­–ç•¥ä¸­é‡‡æ ·å¤šä¸ªè¾“å‡ºï¼› 3. å°†è¿™äº›è¾“å‡ºçš„å¹³å‡å¥–åŠ±è§†ä¸ºåŸºå‡†ï¼› 4. ä»»ä½•é«˜äºå¹³å‡å€¼çš„éƒ½äº§ç”Ÿâ€œæ­£ä¼˜åŠ¿â€ï¼Œä»»ä½•ä½äºå¹³å‡å€¼çš„éƒ½äº§ç”Ÿâ€œè´Ÿä¼˜åŠ¿â€ã€‚</p><p>åŒæ—¶ï¼ŒGRPOä¿ç•™äº† PPO çš„è£å‰ªå’Œ KL æœºåˆ¶ï¼Œä»¥ç¡®ä¿ç¨³å®šã€åˆè§„çš„æ›´æ–°ã€‚</p><h2 id="è‡ªå®šä¹‰è®­ç»ƒå™¨vlmgrpotrainer">è‡ªå®šä¹‰è®­ç»ƒå™¨<code>VLMGRPOTrainer</code></h2><p>åŸºäº <code>Trainer</code> ç±»æ‰©å±•ï¼Œå®ç°äº† Group Relative Policy Optimization (GRPO) æ–¹æ³•çš„è®­ç»ƒï¼Œè¯¥æ–¹æ³•é¦–æ¬¡åœ¨è®ºæ–‡<a target="_blank" rel="noopener" href="https://huggingface.co/papers/2402.03300">DeepSeekMath: Pushing the Limits of Mathematical Reasoning in Open Language Models</a>ä¸­æå‡ºã€‚</p><h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h3><blockquote><p>é»˜è®¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">attn_implementation: <span class="built_in">str</span> = <span class="string">&quot;flash_attention_2&quot;</span>,</span><br><span class="line">torch_dtype: <span class="built_in">str</span> = <span class="string">&quot;bfloat16&quot;</span>,</span><br></pre></td></tr></table></figure><p></p></blockquote><ol type="1"><li><p><strong>åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model_cls = <span class="variable language_">self</span>.vlm_module.get_model_class(model_id, model_init_kwargs)</span><br><span class="line">model = model_cls.from_pretrained(model_id, **model_init_kwargs)</span><br></pre></td></tr></table></figure><p></p></li><li><p><strong>PEFTé…ç½®</strong>:å¦‚æœæä¾›äº† PEFT é…ç½®ï¼ŒæŸ¥æ‰¾<strong>æ¨¡å‹ä¸­çš„æ‰€æœ‰çº¿æ€§å±‚ï¼ˆä¸åŒ…æ‹¬è§†è§‰æ¨¡å—ï¼‰</strong>ï¼Œå¹¶<strong>å°†å®ƒä»¬åº”ç”¨äº LoRAå¾®è°ƒ</strong>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> peft_config <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">  target_modules = find_all_linear_names(model, <span class="variable language_">self</span>.vision_modules_keywords)</span><br><span class="line">  peft_config.target_modules = target_modules</span><br><span class="line">  model = get_peft_model(model, peft_config)</span><br></pre></td></tr></table></figure><p></p></li></ol><blockquote><p>å¯»æ‰¾Pytorchä¸­çš„çº¿æ€§å±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_all_linear_names</span>(<span class="params">model, multimodal_keywords</span>):</span><br><span class="line">   cls = torch.nn.Linear</span><br><span class="line">   lora_module_names = <span class="built_in">set</span>()</span><br><span class="line">   <span class="keyword">for</span> name, module <span class="keyword">in</span> model.named_modules():</span><br><span class="line">       <span class="comment"># ä¸åœ¨è§†è§‰æ¨¡å—ä¸Šåº”ç”¨LoRAå¾®è°ƒ</span></span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">any</span>(mm_keyword <span class="keyword">in</span> name <span class="keyword">for</span> mm_keyword <span class="keyword">in</span> multimodal_keywords):</span><br><span class="line">           <span class="keyword">continue</span></span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, cls):    <span class="comment"># æ£€æŸ¥æ˜¯å¦ä¸ºçº¿æ€§å±‚ï¼ˆå…¨è¿æ¥å±‚ï¼‰</span></span><br><span class="line">           lora_module_names.add(name)</span><br><span class="line">   <span class="keyword">for</span> m <span class="keyword">in</span> lora_module_names:  <span class="comment"># ç§»é™¤åµŒå…¥å±‚</span></span><br><span class="line">       <span class="keyword">if</span> <span class="string">&quot;embed_tokens&quot;</span> <span class="keyword">in</span> m:</span><br><span class="line">           lora_module_names.remove(m)</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">list</span>(lora_module_names)</span><br></pre></td></tr></table></figure><p></p></blockquote><ol start="3" type="1"><li><p><strong>å†»ç»“è§†è§‰æ¨¡å—</strong>ï¼šå¦‚æœ <code>freeze_vision_modules</code> ä¸º <code>True</code>ï¼Œå†»ç»“æ‰€æœ‰è§†è§‰æ¨¡å—çš„å‚æ•°ï¼Œ<strong>ä¸è¿›è¡Œæ¢¯åº¦æ›´æ–°</strong>ï¼›</p></li><li><p><strong>å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆå¦‚æœéœ€è¦ï¼‰</strong>ï¼š<strong>åœ¨åå‘ä¼ æ’­æ—¶ï¼Œä»…å­˜å‚¨éƒ¨åˆ†ä¸­é—´æ¿€æ´»å€¼ï¼Œæ¥å‡å°‘è®­ç»ƒè¿‡ç¨‹ä¸­å¯¹å†…å­˜çš„éœ€æ±‚ã€‚</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> args.gradient_checkpointing:</span><br><span class="line">    model = <span class="variable language_">self</span>._enable_gradient_checkpointing(model, args)</span><br></pre></td></tr></table></figure><p></p></li></ol><p>çœ‹çœ‹å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹çš„å‡½æ•°ï¼š<code>_enable_gradient_checkpointing</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_enable_gradient_checkpointing</span>(<span class="params">self, model: PreTrainedModel, args: GRPOConfig</span>) -&gt; PreTrainedModel:</span><br><span class="line">  <span class="comment"># 1. ç¦ç”¨cacheï¼šç¦ç”¨ç¼“å­˜ä¸­é—´æ¿€æ´»å€¼</span></span><br><span class="line">  model.config.use_cache = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 2. å¯¹äº PEFT æ¨¡å‹å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆPEFT æ¨¡å‹é€šå¸¸é€šè¿‡æ·»åŠ é€‚é…å™¨å±‚è¿›è¡Œå¾®è°ƒï¼Œå…¶ä»–å¤§éƒ¨åˆ†å‚æ•°ä¿æŒå†»ç»“ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> is_peft_model(model):</span><br><span class="line">      model.base_model.gradient_checkpointing_enable()</span><br><span class="line">  <span class="comment"># 3. å¯¹äºé PEFT æ¨¡å‹å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼š</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          model.gradient_checkpointing_enable()</span><br><span class="line">      <span class="keyword">except</span>:</span><br><span class="line">          <span class="string">&#x27;&#x27;&#x27;é¦–å…ˆå°è¯•é€šè¿‡ model.gradient_checkpointing_enable() å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ã€‚å¦‚æœå¤±è´¥ï¼ˆä¾‹å¦‚ï¼ŒæŸäº›æ¨¡å‹ä¸æ”¯æŒè¯¥æ“ä½œï¼‰ï¼Œåˆ™è¿›è¡Œç‰¹å®šæ¨¡å‹çš„ç‰¹æ®Šå¤„ç†ï¼š</span></span><br><span class="line"><span class="string">            1. å¯ç”¨ è§†è§‰æ¨¡å‹ å’Œå…¶ ç¼–ç å™¨ çš„æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼›</span></span><br><span class="line"><span class="string">            2. åœ¨ InternVL æ¨¡å‹ä¸­ï¼Œè¿˜éœ€è¦ç¦ç”¨ gradient_checkpointing å‚æ•°ï¼Œä»¥é¿å…å‡ºç°ä¸æ”¯æŒæ¢¯åº¦æ£€æŸ¥ç‚¹æ“ä½œçš„é”™è¯¯ã€‚</span></span><br><span class="line"><span class="string">          &#x27;&#x27;&#x27;</span></span><br><span class="line">          model.language_model.config.use_cache = <span class="literal">False</span></span><br><span class="line">          model.vision_model.gradient_checkpointing = <span class="literal">True</span></span><br><span class="line">          model.vision_model.encoder.gradient_checkpointing = <span class="literal">True</span></span><br><span class="line">          model.language_model._set_gradient_checkpointing()</span><br><span class="line">          args.gradient_checkpointing = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 4. å¯ç”¨æ¢¯åº¦è®¡ç®—ï¼šè‹¥use_reentrantä¸ºTrueï¼ˆé»˜è®¤ä¸ºTrueï¼‰ï¼Œå¯ç”¨è¾“å…¥å¼ é‡çš„æ¢¯åº¦è®¡ç®—</span></span><br><span class="line">  gradient_checkpointing_kwargs = args.gradient_checkpointing_kwargs <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">  use_reentrant = (</span><br><span class="line">      <span class="string">&quot;use_reentrant&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> gradient_checkpointing_kwargs <span class="keyword">or</span> gradient_checkpointing_kwargs[<span class="string">&quot;use_reentrant&quot;</span>]</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> use_reentrant:</span><br><span class="line">      model.enable_input_require_grads()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure><p></p><ol start="5" type="1"><li><strong>åŠ è½½å‚è€ƒæ¨¡å‹</strong>ï¼š<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> is_deepspeed_zero3_enabled():</span><br><span class="line">  <span class="variable language_">self</span>.ref_model = model_cls.from_pretrained(model_id, **model_init_kwargs)</span><br><span class="line"><span class="keyword">elif</span> peft_config <span class="keyword">is</span> <span class="literal">None</span>:   <span class="comment"># ä¸ä½¿ç”¨PEFTé…ç½®ï¼Œä»åˆå§‹æ¨¡å‹åˆ›å»ºä¸€ä¸ªå‚è€ƒæ¨¡å‹</span></span><br><span class="line">  <span class="comment"># If PEFT configuration is not provided, create a reference model based on the initial model.</span></span><br><span class="line">  <span class="variable language_">self</span>.ref_model = create_reference_model(model)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  <span class="comment"># If PEFT is used, the reference model is not needed since the adapter can be disabled</span></span><br><span class="line">  <span class="comment"># to revert to the initial model.</span></span><br><span class="line">  <span class="variable language_">self</span>.ref_model = <span class="literal">None</span></span><br></pre></td></tr></table></figure></li></ol><p><code>create_reference_model</code>åœ¨<code>TRL</code>æ¡†æ¶ä¸­å®šä¹‰ï¼š<strong>åˆ›å»ºä¸€ä¸ªé™æ€çš„å‚è€ƒæ¨¡å‹ï¼ˆå‚è€ƒæ¨¡å‹æ˜¯åŸå§‹æ¨¡å‹çš„å‰¯æœ¬ï¼‰ï¼Œå…¶éƒ¨åˆ†å‚æ•°è¢«å†»ç»“ï¼Œä»¥ä¾¿åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸å†æ›´æ–°</strong>ã€‚</p><blockquote><p>å†»ç»“å‚æ•°ï¼š * <strong>å†»ç»“æ‰€æœ‰å‚æ•°</strong>ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šå…±äº«å±‚æ•°ï¼ˆ<code>num_shared_layers</code> ä¸º <code>None</code>ï¼‰ï¼Œåˆ™å‡½æ•°ä¼šå†»ç»“æ‰€æœ‰çš„å‚æ•°ã€‚è¿™æ„å‘³ç€å‚è€ƒæ¨¡å‹çš„æ‰€æœ‰å‚æ•°éƒ½ä¸ä¼šåœ¨è®­ç»ƒä¸­è¢«æ›´æ–°ï¼Œé€šå¸¸è¿™ç§æ–¹æ³•ç”¨äºæ„å»ºä¸€ä¸ªå›ºå®šçš„åŸºå‡†æ¨¡å‹æˆ–ç”¨äºçŸ¥è¯†è’¸é¦ç­‰åœºæ™¯ã€‚ * <strong>å†»ç»“éƒ¨åˆ†å‚æ•°ï¼ˆå…±äº«å±‚ï¼‰</strong>ï¼šå¦‚æœæŒ‡å®šäº† <code>num_shared_layers</code>ï¼Œåˆ™å‡½æ•°ä¼šæ ¹æ®è¯¥å€¼å†»ç»“æ¨¡å‹çš„å‰å‡ ä¸ªå±‚ï¼ˆæ ¹æ®å±‚æ•°æˆ–æŒ‡å®šçš„å±‚åæ¨¡å¼ï¼‰ã€‚è¿™æ„å‘³ç€è¿™äº›å±‚çš„å‚æ•°ä¸ä¼šæ›´æ–°ï¼Œä»è€Œè®©æ¨¡å‹åªå¯¹åé¢çš„å±‚è¿›è¡Œè®­ç»ƒã€‚</p></blockquote><p>æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ï¼š<a target="_blank" rel="noopener" href="https://github.com/huggingface/trl/blob/d625c5533a6b1c84d3565c8080857f6bb81c538a/trl/models/modeling_base.py#L605">trl/trl/models /modeling_base.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_reference_model</span>(<span class="params"></span></span><br><span class="line"><span class="params">    model: PreTrainedModelWrapper, num_shared_layers: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>, pattern: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span></span><br><span class="line"><span class="params"></span>) -&gt; PreTrainedModelWrapper:</span><br><span class="line">    <span class="comment"># 1. å…¼å®¹æ€§æ£€æŸ¥ï¼šä¸æ”¯æŒDeepSpeed çš„ ZeRO-3 æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> is_deepspeed_zero3_enabled():</span><br><span class="line">        <span class="keyword">raise</span> ValueError(</span><br><span class="line">            <span class="string">&quot;DeepSpeed ZeRO-3 is enabled and is not compatible with `create_reference_model()`. Please instantiate your reference model directly with `AutoModelForCausalLM.from_pretrained()`.&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    parameter_names = [n <span class="keyword">for</span> n, _ <span class="keyword">in</span> model.named_parameters()]</span><br><span class="line">    <span class="comment"># 2. å¤åˆ¶æ¨¡å‹ï¼ˆæ·±æ‹·è´ï¼‰</span></span><br><span class="line">    ref_model = deepcopy(model)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. å¦‚æœæ²¡æœ‰å…±äº«å±‚ï¼Œåˆ™å†»ç»“æ‰€æœ‰å‚æ•°å¹¶è¿”å›æ¨¡å‹å‰¯æœ¬ï¼šï¼ˆé€šå¸¸ç”¨äºæ„å»ºä¸€ä¸ªå›ºå®šçš„åŸºå‡†æ¨¡å‹ï¼Œæˆ–ç”¨äºçŸ¥è¯†è’¸é¦ç­‰åœºæ™¯ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> num_shared_layers <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> param_name <span class="keyword">in</span> parameter_names:</span><br><span class="line">            param = ref_model.get_parameter(param_name)</span><br><span class="line">            param.requires_grad = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> ref_model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. å¦‚æœæœ‰å…±äº«å±‚ï¼Œç¡®å®šå…±äº«å±‚çš„é€‰æ‹©æ¨¡å¼ï¼š</span></span><br><span class="line">    <span class="comment"># å¦‚æœæŒ‡å®šäº† pattern å‚æ•°ï¼Œåˆ™ä½¿ç”¨è¯¥æ¨¡å¼æ¥é€‰æ‹©å…±äº«å±‚ï¼›å¦åˆ™ï¼Œå‡½æ•°ä¼šéå† LAYER_PATTERNS ä¸­çš„æ¨¡å¼ï¼Œé€‰æ‹©ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…å‚æ•°åç§°çš„æ¨¡å¼ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> pattern <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        pattern = pattern.<span class="built_in">format</span>(layer=num_shared_layers)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> pattern_candidate <span class="keyword">in</span> LAYER_PATTERNS:</span><br><span class="line">            pattern_candidate = pattern_candidate.<span class="built_in">format</span>(layer=num_shared_layers)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(pattern_candidate <span class="keyword">in</span> name <span class="keyword">for</span> name <span class="keyword">in</span> parameter_names):</span><br><span class="line">                pattern = pattern_candidate</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pattern <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Layer pattern could not be matched.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. å°†å‚æ•°åˆ†ä¸ºå…±äº«å’Œéå…±äº«ä¸¤ç±»ï¼š</span></span><br><span class="line">    shared_param_list = []</span><br><span class="line">    unshared_param_list = []</span><br><span class="line"></span><br><span class="line">    shared_parameter = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> name, _param <span class="keyword">in</span> model.named_parameters():</span><br><span class="line">        <span class="keyword">if</span> pattern <span class="keyword">in</span> name:</span><br><span class="line">            shared_parameter = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> shared_parameter:</span><br><span class="line">            shared_param_list.append(name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            unshared_param_list.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6. å†»ç»“åŸå§‹æ¨¡å‹ä¸­æ‰€æœ‰å±äºå…±äº«å±‚çš„å‚æ•°ï¼š</span></span><br><span class="line">    <span class="keyword">for</span> param_name <span class="keyword">in</span> shared_param_list:</span><br><span class="line">        param = model.get_parameter(param_name)</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        _ref_param = ref_model.get_parameter(param_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7. å†»ç»“å‚è€ƒæ¨¡å‹ä¸­æ‰€æœ‰å±äºéå…±äº«å±‚çš„å‚æ•°ï¼š</span></span><br><span class="line">    <span class="keyword">for</span> param_name <span class="keyword">in</span> unshared_param_list:</span><br><span class="line">        param = ref_model.get_parameter(param_name)</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pattern <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">len</span>(unshared_param_list) == <span class="number">0</span>:</span><br><span class="line">        logging.warning(<span class="string">&quot;Pattern passed or found, but no layers matched in the model. Check for a typo.&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 8. è¿”å›å‚è€ƒæ¨¡å‹</span></span><br><span class="line">    <span class="keyword">return</span> ref_model.<span class="built_in">eval</span>()</span><br></pre></td></tr></table></figure><ol start="6" type="1"><li><strong>å¤„ç†ç±»ï¼ˆ<code>processing_class</code>ï¼‰åˆå§‹åŒ–</strong>ï¼š</li></ol><ul><li><p>å¦‚æœ<code>processing_class</code>å‚æ•°ä¸ºç©ºï¼šä»<code>vlm_module</code>æ¨¡å—ä¸­è·å–ç›¸åº”çš„å¤„ç†ç±»ï¼Œå¹¶ä»é¢„è®­ç»ƒæ¨¡å‹ä¸­åŠ è½½ã€‚</p></li><li><p>éšåï¼Œå¤„ç†ç±»æ ¹æ®<code>kwargs</code>è®¾ç½®è‡ªå®šä¹‰çš„å¤„ç†å…³é”®è¯ï¼š</p><ul><li>å¦‚æœè¯¥å¤„ç†ç±»æœ‰ tokenizerï¼Œåˆ™è®¾ç½®å…¶å¡«å……å’Œç»“æŸæ ‡è®° IDï¼›</li><li>å¦åˆ™è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œç¡®ä¿è¯¥å¤„ç†ç±»æ˜¯<code>PreTrainedTokenizerBase</code>ç±»å‹ã€‚</li></ul></li></ul><ol start="7" type="1"><li><strong>å¯¹ä¸»æ¨¡å‹ã€å‚è€ƒæ¨¡å‹è¿›è¡Œåˆå§‹åŒ–</strong>ï¼š</li></ol><ul><li><code>Qwen2VLModule</code>æ— éœ€å¤„ç†ï¼›<code>InvernVLModule</code>éœ€è¦ä»æ¨¡å‹ä¸­æå–å¹¶èµ‹å€¼åˆ°å½“å‰å¯¹è±¡ä¸­ï¼Œå¹¶ä¸”å°†å›¾åƒä¸Šä¸‹æ–‡çš„ token ID å¤„ç†å¹¶å­˜å‚¨åˆ°æ¨¡å‹ã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">self</span>.vlm_module.post_model_init(model, processing_class)</span><br><span class="line"><span class="variable language_">self</span>.vlm_module.post_model_init(<span class="variable language_">self</span>.ref_model, processing_class)</span><br></pre></td></tr></table></figure></li></ul><ol start="8" type="1"><li><p><strong>å¥–åŠ±å‡½æ•°<code>reward_funcs</code>ï¼Œå¥–åŠ±å¤„ç†ç±»<code>reward_processing_classes</code>åˆå§‹åŒ–</strong></p></li><li><p><strong>å¤„ç†å¥–åŠ±å‡½æ•°çš„ Tokenizer</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, (reward_processing_class, reward_func) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(reward_processing_classes, reward_funcs)):</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">isinstance</span>(reward_func, PreTrainedModel):</span><br><span class="line">      <span class="keyword">if</span> reward_processing_class <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">          reward_processing_class = AutoTokenizer.from_pretrained(reward_func.config._name_or_path)</span><br><span class="line">      <span class="keyword">if</span> reward_processing_class.pad_token_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">          reward_processing_class.pad_token = reward_processing_class.eos_token</span><br><span class="line">      <span class="comment"># è®¡ç®—è¾“å…¥åºåˆ—ä¸­ï¼šæœ€æ–°non-padded tokençš„å¥–åŠ±</span></span><br><span class="line">      reward_func.config.pad_token_id = reward_processing_class.pad_token_id</span><br><span class="line">      reward_processing_classes[i] = reward_processing_class</span><br><span class="line"><span class="variable language_">self</span>.reward_processing_classes = reward_processing_classes</span><br></pre></td></tr></table></figure><p></p></li><li><p><strong>è®­ç»ƒå‚æ•°çš„åˆå§‹åŒ–</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">self</span>.max_prompt_length = args.max_prompt_length</span><br><span class="line">  <span class="variable language_">self</span>.max_prompt_length = <span class="literal">None</span></span><br><span class="line">  <span class="keyword">if</span> args.max_prompt_length <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">      warnings.warn(<span class="string">&quot;Setting max_prompt_length is currently not supported, it has been set to None&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">self</span>.max_completion_length = args.max_completion_length  <span class="comment"># = |o_i| in the GRPO paper</span></span><br><span class="line">  <span class="variable language_">self</span>.num_generations = args.num_generations  <span class="comment"># = G in the GRPO paper</span></span><br><span class="line">  <span class="variable language_">self</span>.generation_config = GenerationConfig(</span><br><span class="line">      max_new_tokens=<span class="variable language_">self</span>.max_completion_length,</span><br><span class="line">      do_sample=<span class="literal">True</span>,  </span><br><span class="line">      temperature=<span class="number">1</span>,</span><br><span class="line">      pad_token_id=pad_token_id,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.vlm_module, <span class="string">&quot;get_eos_token_id&quot;</span>): <span class="comment"># For InternVL</span></span><br><span class="line">      <span class="variable language_">self</span>.generation_config.eos_token_id = <span class="variable language_">self</span>.vlm_module.get_eos_token_id(processing_class)</span><br><span class="line">      <span class="built_in">print</span>(<span class="number">222</span>, <span class="variable language_">self</span>.vlm_module.get_eos_token_id(processing_class))</span><br><span class="line">  <span class="variable language_">self</span>.beta = args.beta</span><br><span class="line">  <span class="variable language_">self</span>.epsilon = args.</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å¤šæ­¥</span></span><br><span class="line">  <span class="variable language_">self</span>.num_iterations = args.num_iterations  <span class="comment"># = ğœ‡ in the GRPO paper</span></span><br><span class="line">  <span class="comment"># è¿­ä»£æ­¥æ•°ï¼ˆå‰å‘+åå‘ä¼ æ’­ï¼‰</span></span><br><span class="line">  <span class="variable language_">self</span>._step = <span class="number">0</span>    </span><br><span class="line">  <span class="comment"># _buffered_inputsç¼“å­˜æ‰¹æ¬¡ä¸­çš„è¾“å…¥ï¼Œé¿å…é‡å¤ç”Ÿæˆ</span></span><br><span class="line">  <span class="variable language_">self</span>._buffered_inputs = [<span class="literal">None</span>] * args.gradient_accumulation_steps</span><br></pre></td></tr></table></figure><p></p></li><li><p><strong>è®¾ç½®éšæœºç§å­</strong></p></li><li><p><strong>åˆå§‹åŒ–å‚è€ƒæ¨¡å‹<code>ref_model</code></strong></p></li><li><p><strong>å‡†å¤‡å¥–åŠ±å‡½æ•°</strong></p></li></ol><h2 id="è®­ç»ƒè¿‡ç¨‹">è®­ç»ƒè¿‡ç¨‹</h2><p>ä»è„šæœ¬<code>grpo_rec.sh</code>å¼€å§‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">torchrun --nproc_per_node=<span class="string">&quot;8&quot;</span> \     // æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„è¿›ç¨‹æ•°ï¼šä½¿ç”¨çš„ GPU æ•°é‡</span><br><span class="line">    --nnodes=<span class="string">&quot;1&quot;</span> \                  // è®­ç»ƒçš„èŠ‚ç‚¹æ•°</span><br><span class="line">    --node_rank=<span class="string">&quot;0&quot;</span> \               // å½“å‰èŠ‚ç‚¹çš„æ’å</span><br><span class="line">    --master_addr=<span class="string">&quot;127.0.0.1&quot;</span> \     // ä¸»èŠ‚ç‚¹çš„ IP åœ°å€</span><br><span class="line">    --master_port=<span class="string">&quot;12346&quot;</span> \         // ä¸»èŠ‚ç‚¹ç›‘å¬çš„ç«¯å£å·</span><br><span class="line">    src/open_r1/grpo_rec.py \       // å®é™…è¿è¡Œçš„è®­ç»ƒè„šæœ¬è·¯å¾„</span><br><span class="line">    --deepspeed local_scripts/zero3.json \      // ä½¿ç”¨ DeepSpeed æ¥ä¼˜åŒ–è®­ç»ƒ</span><br><span class="line">    --output_dir output/<span class="variable">$RUN_NAME</span> \</span><br><span class="line">    --model_name_or_path Qwen/Qwen2.5-VL-3B-Instruct \</span><br><span class="line">    --dataset_name data_config/rec.yaml \</span><br><span class="line">    --image_root &lt;your_image_root&gt; \</span><br><span class="line">    --max_prompt_length 1024 \</span><br><span class="line">    --num_generations 8 \           // æ¯ä¸ªè¾“å…¥ç”Ÿæˆçš„è¾“å‡ºæ•°é‡</span><br><span class="line">    --per_device_train_batch_size 1 \</span><br><span class="line">    --gradient_accumulation_steps 2 \</span><br><span class="line">    --logging_steps 1 \</span><br><span class="line">    --bf16 \                        // ä½¿ç”¨ bfloat16 æ•°æ®ç±»å‹</span><br><span class="line">    --torch_dtype bfloat16 \        // å¼ é‡æ•°æ®ç±»å‹ä¸º bfloat16</span><br><span class="line">    --data_seed 42 \</span><br><span class="line">    --report_to wandb \</span><br><span class="line">    --gradient_checkpointing <span class="literal">false</span> \</span><br><span class="line">    --attn_implementation flash_attention_2 \</span><br><span class="line">    --num_train_epochs 2 \</span><br><span class="line">    --run_name <span class="variable">$RUN_NAME</span> \</span><br><span class="line">    --save_steps 100 \</span><br><span class="line">    --save_only_model <span class="literal">true</span></span><br></pre></td></tr></table></figure><p></p><p><code>grpo_rec.py</code>å…¥å£å‡½æ•°ï¼š</p><ol type="1"><li><p><strong>åŠ è½½VLMæ¨¡å‹</strong>ï¼š<code>vlm_module_cls = get_vlm_module(model_args.model_name_or_path)</code>ï¼Œæ”¯æŒï¼š<code>Qwen2VLModule</code>å’Œ<code>InvernVLModule</code></p></li><li><p><strong>åŠ è½½å¥–åŠ±å‡½æ•°</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reward_funcs_registry = &#123;</span><br><span class="line">    <span class="string">&quot;accuracy&quot;</span>: vlm_module_cls.iou_reward,</span><br><span class="line">    <span class="string">&quot;format&quot;</span>: vlm_module_cls.format_reward_rec,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p></li></ol><blockquote><p>æ£€æŸ¥æ¨¡å‹è¾“å‡ºæ ¼å¼ï¼š<code>format_reward_rec</code> * æ£€æŸ¥æ˜¯å¦åŒ…å«<code>think</code> å’Œ <code>answer</code> æ ‡ç­¾ï¼› * <code>answer</code>æ ‡ç­¾ä¸­å†…å®¹ç¬¦åˆä¸€ä¸ªç‰¹å®šçš„è¾¹ç•Œæ¡†æ ¼å¼ï¼ˆå¦‚ <code>[x, y, w, h]</code>ï¼‰ï¼› * ç¬¦åˆæ ¼å¼çš„è¾“å‡ºå¥–åŠ±ä¸º 1.0ï¼Œä¸ç¬¦åˆæ ¼å¼çš„è¾“å‡ºå¥–åŠ±ä¸º 0.0.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">format_reward_rec</span>(<span class="params">completions, **kwargs</span>):</span><br><span class="line">   <span class="keyword">import</span> re</span><br><span class="line">   pattern = <span class="string">r&quot;&lt;think&gt;.*?&lt;/think&gt;\s*&lt;answer&gt;.*?\&#123;.*\[\d+,\s*\d+,\s*\d+,\s*\d+\].*\&#125;.*?&lt;/answer&gt;&quot;</span></span><br><span class="line">   completion_contents = [completion[<span class="number">0</span>][<span class="string">&quot;content&quot;</span>] <span class="keyword">for</span> completion <span class="keyword">in</span> completions]</span><br><span class="line">   matches = [re.search(pattern, content, re.DOTALL) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">for</span> content <span class="keyword">in</span> completion_contents]</span><br><span class="line">   <span class="keyword">return</span> [<span class="number">1.0</span> <span class="keyword">if</span> <span class="keyword">match</span> <span class="keyword">else</span> <span class="number">0.0</span> <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> matches]</span><br></pre></td></tr></table></figure><p></p></blockquote><ol start="3" type="1"><li><strong>åŠ è½½æ•°æ®é›†</strong>ï¼š<code>LazySupervisedDataset</code>ï¼ˆç¬¦åˆ<code>Pytorch</code>æ ¼å¼ï¼‰</li></ol><p>æ•°æ®åº”ä¸º<code>.yaml</code>æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŒ…å«ä¸€ä¸ª <code>datasets</code> å­—æ®µï¼Œå…¶ä¸­<strong>åˆ—å‡ºäº†å¤šä¸ªæ•°æ®æºçš„è·¯å¾„ä»¥åŠç›¸åº”çš„é‡‡æ ·ç­–ç•¥</strong>ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasets:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">json_path:</span> <span class="string">xxxx1.json</span></span><br><span class="line">     <span class="attr">sampling_strategy:</span> <span class="string">first:1000</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">json_path:</span> <span class="string">xxxx2.json</span></span><br><span class="line">     <span class="attr">sampling_strategy:</span> <span class="string">end:3000</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">json_path:</span> <span class="string">xxxx3.json</span></span><br><span class="line">     <span class="attr">sampling_strategy:</span> <span class="string">random:999</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸€å…±æ”¯æŒ3ç§é‡‡æ ·ç­–ç•¥ï¼š</p><ul><li>"first"ï¼šå–å‰ sampling_number ä¸ªæ ·æœ¬ï¼›</li><li>"end"ï¼šå–æœ€å sampling_number ä¸ªæ ·æœ¬ï¼›</li><li>"random"ï¼šéšæœºæ‰“ä¹±æ•°æ®å¹¶å–å‰ sampling_number ä¸ªæ ·æœ¬ã€‚</li></ul><h4 id="å¥–åŠ±å‡½æ•°iou_reward">å¥–åŠ±å‡½æ•°ï¼š<code>iou_reward</code></h4><h5 id="qwen2vlmoduleçš„reward">Qwen2VLModuleçš„reward</h5><p><strong>è®¡ç®—é¢„æµ‹çš„è¾¹ç•Œæ¡†ä¸çœŸå®è¾¹ç•Œæ¡†ä¹‹é—´çš„IoUå¥–åŠ±</strong>:æ¯”è¾ƒé¢„æµ‹çš„è¾¹ç•Œæ¡†å’ŒçœŸå®è¾¹ç•Œæ¡†çš„é‡å éƒ¨åˆ†ï¼ˆäº¤é›†ï¼‰ä¸å®ƒä»¬çš„å¹¶é›†çš„æ¯”å€¼</p><ol type="1"><li><p><code>IOU</code>å‡½æ•°å®šä¹‰ï¼š<code>inter</code>ä¸ºäº¤é›†é¢ç§¯ï¼›<code>union</code>ä¸ºå¹¶é›†é¢ç§¯ï¼›æ¯”å€¼ä¸ºIOU</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">iou</span>(<span class="params">box1, box2</span>):</span><br><span class="line">    inter_x1 = <span class="built_in">max</span>(box1[<span class="number">0</span>], box2[<span class="number">0</span>])</span><br><span class="line">    inter_y1 = <span class="built_in">max</span>(box1[<span class="number">1</span>], box2[<span class="number">1</span>])</span><br><span class="line">    inter_x2 = <span class="built_in">min</span>(box1[<span class="number">2</span>]-<span class="number">1</span>, box2[<span class="number">2</span>]-<span class="number">1</span>)</span><br><span class="line">    inter_y2 = <span class="built_in">min</span>(box1[<span class="number">3</span>]-<span class="number">1</span>, box2[<span class="number">3</span>]-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> inter_x1 &lt; inter_x2 <span class="keyword">and</span> inter_y1 &lt; inter_y2:</span><br><span class="line">        inter = (inter_x2-inter_x1+<span class="number">1</span>)*(inter_y2-inter_y1+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inter = <span class="number">0</span></span><br><span class="line">    union = (box1[<span class="number">2</span>]-box1[<span class="number">0</span>])*(box1[<span class="number">3</span>]-box1[<span class="number">1</span>]) + (box2[<span class="number">2</span>]-box2[<span class="number">0</span>])*(box2[<span class="number">3</span>]-box2[<span class="number">1</span>]) - inter</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">float</span>(inter)/union</span><br></pre></td></tr></table></figure><p></p></li><li><p>ä¸»è¦é€»è¾‘ï¼š<strong>éå†æ¯ä¸ªé¢„æµ‹å€¼ï¼Œæå–å‡ºè¾¹ç•Œæ¡†ï¼Œè®¡ç®—é¢„æµ‹å’ŒçœŸå®è¾¹ç•Œæ¡†çš„ IoU å€¼ä½œä¸ºå¥–åŠ±</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä» completions ä¸­æå–å‡ºæ¯ä¸ªé¢„æµ‹ç»“æœçš„ content å­—æ®µ</span></span><br><span class="line">contents = [completion[<span class="number">0</span>][<span class="string">&quot;content&quot;</span>] <span class="keyword">for</span> completion <span class="keyword">in</span> completions]</span><br><span class="line">rewards = []  <span class="comment"># å­˜å‚¨æ¯ä¸ªé¢„æµ‹çš„å¥–åŠ±å€¼ï¼ˆIoU å€¼ï¼‰</span></span><br><span class="line">current_time = datetime.now().strftime(<span class="string">&quot;%d-%H-%M-%S-%f&quot;</span>)</span><br><span class="line">answer_tag_pattern = <span class="string">r&#x27;&lt;answer&gt;(.*?)&lt;/answer&gt;&#x27;</span></span><br><span class="line">bbox_pattern = <span class="string">r&#x27;\[(\d+),\s*(\d+),\s*(\d+),\s*(\d+)]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> content, sol <span class="keyword">in</span> <span class="built_in">zip</span>(contents, solution):</span><br><span class="line">    reward = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="comment"># content_answer_matchï¼šæŸ¥æ‰¾ &lt;answer&gt;...&lt;/answer&gt; æ ‡ç­¾ï¼Œå¹¶æå–å…¶ä¸­çš„ç­”æ¡ˆ</span></span><br><span class="line">        content_answer_match = re.search(answer_tag_pattern, content, re.DOTALL)</span><br><span class="line">        <span class="keyword">if</span> content_answer_match:</span><br><span class="line">            content_answer = content_answer_match.group(<span class="number">1</span>).strip()</span><br><span class="line">            <span class="comment"># bbox_matchï¼šåœ¨ç­”æ¡ˆä¸­æå–è¾¹ç•Œæ¡†ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ [x1, y1, x2, y2]</span></span><br><span class="line">            bbox_match = re.search(bbox_pattern, content_answer)</span><br><span class="line">            <span class="keyword">if</span> bbox_match:</span><br><span class="line">                bbox = [<span class="built_in">int</span>(bbox_match.group(<span class="number">1</span>)), <span class="built_in">int</span>(bbox_match.group(<span class="number">2</span>)), <span class="built_in">int</span>(bbox_match.group(<span class="number">3</span>)), <span class="built_in">int</span>(bbox_match.group(<span class="number">4</span>))]</span><br><span class="line">                <span class="comment"># if iou(bbox, sol) &gt; 0.5:</span></span><br><span class="line">                <span class="comment">#     reward = 1.0</span></span><br><span class="line">                <span class="comment"># reward = iou(bbox, sol)ï¼šè®¡ç®—é¢„æµ‹çš„è¾¹ç•Œæ¡† bbox å’ŒçœŸå®è¾¹ç•Œæ¡† sol ä¹‹é—´çš„ IoU å€¼ï¼Œä½œä¸ºå¥–åŠ±</span></span><br><span class="line">                reward = iou(bbox, sol)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span>  </span><br><span class="line">            </span><br><span class="line">    rewards.append(reward)</span><br><span class="line">    <span class="keyword">if</span> os.getenv(<span class="string">&quot;DEBUG_MODE&quot;</span>) == <span class="string">&quot;true&quot;</span>:</span><br><span class="line">        log_path = os.getenv(<span class="string">&quot;LOG_PATH&quot;</span>)</span><br><span class="line">        <span class="comment"># local_rank = int(os.getenv(&quot;LOCAL_RANK&quot;, 0))</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_path, <span class="string">&quot;a&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">f&quot;------------- <span class="subst">&#123;current_time&#125;</span> Accuracy reward: <span class="subst">&#123;reward&#125;</span> -------------\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">f&quot;Content: <span class="subst">&#123;content&#125;</span>\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">f&quot;Solution: <span class="subst">&#123;sol&#125;</span>\n&quot;</span>)</span><br></pre></td></tr></table></figure><p></p></li></ol><h2 id="grpo-configå‚æ•°">GRPO Configå‚æ•°</h2><h3 id="æ•°æ®é¢„å¤„ç†å‚æ•°">æ•°æ®é¢„å¤„ç†å‚æ•°</h3><ul><li><code>remove_unused_columns (Optional[bool])</code>:å¦‚æœè®¾ç½®ä¸º <code>True</code>ï¼Œåˆ™ä»…ä¿ç•™æ•°æ®é›†ä¸­çš„ "prompt" åˆ—ï¼Œé»˜è®¤å€¼ä¸º <code>False</code>ã€‚ç”¨äºè®¡ç®—è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°ï¼›</li><li><code>max_prompt_length (Optional[int])</code>: prompt çš„æœ€å¤§é•¿åº¦ï¼Œé»˜è®¤å€¼ä¸º <code>512</code>ï¼ˆå¦‚æœ prompt é•¿åº¦è¶…è¿‡æ­¤å€¼ï¼Œå°†ä¼šä»å·¦ä¾§è¿›è¡Œæˆªæ–­ï¼‰</li><li><code>num_generations (Optional[int])</code>:æ¯ä¸ª prompt ç”Ÿæˆçš„æ ·æœ¬æ•°é‡ã€‚å…¨å±€æ‰¹æ¬¡å¤§å°ï¼ˆnum_processes * per_device_batch_sizeï¼‰å¿…é¡»èƒ½è¢«æ­¤å€¼æ•´é™¤ï¼Œé»˜è®¤å€¼ä¸º <code>8</code>;</li><li><code>temperature (Optional[float])</code>ï¼šé‡‡æ ·çš„æ¸©åº¦å€¼ã€‚æ¸©åº¦è¶Šé«˜ï¼Œç”Ÿæˆæ ·æœ¬çš„éšæœºæ€§è¶Šé«˜ï¼Œé»˜è®¤å€¼ä¸º<code>0.9</code>ï¼›</li><li><code>max_completion_length (Optional[int])</code>:ç”Ÿæˆçš„å®Œæˆéƒ¨åˆ†çš„æœ€å¤§é•¿åº¦ï¼Œé»˜è®¤å€¼ä¸º <code>256</code>ï¼›</li><li><code>ds3_gather_for_generation (bool)</code>:é’ˆå¯¹ DeepSpeed ZeRO-3 çš„è®¾ç½®ã€‚å¯ç”¨æ—¶ï¼Œ<strong>ç”Ÿæˆæ—¶ä¼šæ”¶é›†ç­–ç•¥æ¨¡å‹çš„æƒé‡ï¼Œæå‡ç”Ÿæˆé€Ÿåº¦</strong>ï¼›å¦‚æœç¦ç”¨æ­¤é€‰é¡¹ï¼Œèƒ½å¤Ÿè®­ç»ƒè¶…è¿‡å•ä¸ª GPU VRAM å®¹é‡çš„æ¨¡å‹ï¼Œä½†ç”Ÿæˆé€Ÿåº¦ä¼šæ›´æ…¢ï¼Œå¹¶ä¸”ä¸ vLLM ç”Ÿæˆä¸å…¼å®¹ã€‚é»˜è®¤å€¼ä¸º <code>True</code>ã€‚</li></ul><h3 id="ç”ŸæˆåŠ é€Ÿç›¸å…³å‚æ•°vllm">ç”ŸæˆåŠ é€Ÿç›¸å…³å‚æ•°ï¼ˆvLLMï¼‰</h3><ul><li><code>use_vllm (Optional[bool])</code>:æ˜¯å¦ä½¿ç”¨ vLLMï¼ˆä¸€ä¸ªç”¨äºç”Ÿæˆçš„åŠ é€Ÿåº“ï¼‰è¿›è¡Œç”Ÿæˆï¼Œå¦‚æœè®¾ç½®ä¸º <code>True</code>ï¼Œåˆ™éœ€è¦ç¡®ä¿æœ‰ä¸€ä¸ª GPU ç”¨äºç”Ÿæˆï¼Œè€Œä¸æ˜¯è®­ç»ƒï¼›é»˜è®¤ä¸º<code>False</code></li><li><code>vllm_device (Optional[str])</code>:æŒ‡å®š vLLM ç”Ÿæˆå°†è¿è¡Œçš„è®¾å¤‡ï¼Œä¾‹å¦‚ "cuda:1"ã€‚å¦‚æœè®¾ç½®ä¸º "auto"ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©ä¸‹ä¸€ä¸ªå¯ç”¨çš„ GPUï¼›</li><li><code>vllm_gpu_memory_utilization (float)</code>:è¯¥å€¼æŒ‡å®šè¦ä¸º vLLM ç”Ÿæˆé¢„ç•™çš„ GPU å†…å­˜æ¯”ä¾‹ã€‚æ•°å€¼èŒƒå›´ä¸º 0 åˆ° 1ï¼Œè¾ƒé«˜çš„æ•°å€¼ä¼šå¢åŠ  KV ç¼“å­˜å¤§å°ï¼Œä»è€Œæé«˜æ¨¡å‹çš„ååé‡ï¼Œä½†å¦‚æœè¿‡é«˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ï¼ˆOOMï¼‰é”™è¯¯ã€‚é»˜è®¤å€¼ä¸º <code>0.9</code>ï¼›</li><li><code>vllm_dtype (Optional[str])</code>:è®¾ç½® vLLM ç”Ÿæˆçš„æ•°å€¼ç±»å‹ã€‚å¦‚æœè®¾ç½®ä¸º "auto"ï¼Œå°†åŸºäºæ¨¡å‹é…ç½®è‡ªåŠ¨é€‰æ‹©æ•°æ®ç±»å‹ï¼›</li><li><code>vllm_max_model_len (Optional[int])</code>:è®¾ç½® vLLM ä½¿ç”¨çš„æœ€å¤§æ¨¡å‹é•¿åº¦ã€‚è¿™å¯¹äºå‡å°‘ <code>vllm_gpu_memory_utilization</code> çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡å°‘ KV ç¼“å­˜å¤§å°ã€‚å¦‚æœæœªè®¾ç½®ï¼ŒvLLM å°†ä½¿ç”¨æ¨¡å‹çš„ä¸Šä¸‹æ–‡å¤§å°ï¼›</li><li><code>vllm_enable_prefix_caching (Optional[bool])</code>:æ˜¯å¦å¯ç”¨ vLLM ä¸­çš„å‰ç¼€ç¼“å­˜ã€‚è‹¥ä¸º <code>True</code>ï¼ˆé»˜è®¤ï¼‰ï¼Œç¡®ä¿æ¨¡å‹å’Œç¡¬ä»¶æ”¯æŒæ­¤åŠŸèƒ½ï¼›</li><li><code>vllm_guided_decoding_regex (Optional[str])</code>:ç”¨äº vLLM æŒ‡å¯¼è§£ç çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚å¦‚æœä¸º <code>None</code>ï¼ˆé»˜è®¤ï¼‰ï¼Œåˆ™ç¦ç”¨æŒ‡å¯¼è§£ç ã€‚</li></ul><h3 id="è®­ç»ƒæ§åˆ¶å‚æ•°">è®­ç»ƒæ§åˆ¶å‚æ•°</h3><ul><li><code>learning_rate (float)</code>:åˆå§‹å­¦ä¹ ç‡ï¼Œä½¿ç”¨ AdamW ä¼˜åŒ–å™¨ã€‚é»˜è®¤å€¼ä¸º <code>1e-6</code>ï¼Œå®ƒæ›¿æ¢äº† <code>transformers.TrainingArguments</code> ä¸­çš„é»˜è®¤å­¦ä¹ ç‡ï¼›</li><li><code>beta (float)</code>:KL ç³»æ•°ã€‚å€¼ä¸º <code>0.0</code> æ—¶ï¼Œå‚è€ƒæ¨¡å‹ä¸ä¼šåŠ è½½ï¼Œä»è€Œå‡å°‘å†…å­˜ä½¿ç”¨å’Œæé«˜è®­ç»ƒé€Ÿåº¦ã€‚é»˜è®¤å€¼ä¸º <code>0.04</code>ï¼›</li><li><code>num_iterations (int)</code>:æ¯ä¸ªæ‰¹æ¬¡çš„è¿­ä»£æ¬¡æ•°ï¼ˆåœ¨ç®—æ³•ä¸­è¡¨ç¤ºä¸º<span class="math inline">\(\mu\)</span>ï¼‰ã€‚é»˜è®¤å€¼ä¸º 1ï¼›</li><li><code>epsilon (float)</code>:ç”¨äºè£å‰ªçš„ epsilon å€¼ã€‚é»˜è®¤å€¼ä¸º <code>0.2</code>ï¼›</li><li><code>reward_weights (Optional[list[float]])</code>:æ¯ä¸ªå¥–åŠ±å‡½æ•°çš„æƒé‡ã€‚å¦‚æœä¸º <code>None</code>ï¼Œåˆ™æ‰€æœ‰å¥–åŠ±å‡½æ•°çš„æƒé‡å‡ä¸º <code>1.0</code>ï¼Œé»˜è®¤å€¼ä¸º <code>None</code>ï¼›</li><li><code>sync_ref_model (bool)</code>:æ˜¯å¦æ¯ <code>ref_model_sync_steps</code> æ­¥åŒæ­¥å‚è€ƒæ¨¡å‹å’Œæ´»åŠ¨æ¨¡å‹ï¼Œä½¿ç”¨ <code>ref_model_mixup_alpha</code> å‚æ•°è¿›è¡Œæ··åˆã€‚é»˜è®¤å€¼ä¸º <code>False</code>ï¼›</li><li><code>ref_model_mixup_alpha (float)</code>:å‚è€ƒæ¨¡å‹æ›´æ–°æ—¶çš„ <span class="math inline">\(\alpha\)</span> å‚æ•°ï¼Œæ§åˆ¶å½“å‰ç­–ç•¥å’Œå‰ä¸€ä¸ªå‚è€ƒç­–ç•¥ä¹‹é—´çš„æ··åˆã€‚é»˜è®¤å€¼ä¸º <code>0.6</code>ã€‚æ­¤å‚æ•°å¿…é¡»ä¸ <code>sync_ref_model=True</code> ä¸€èµ·ä½¿ç”¨ï¼›</li><li><code>ref_model_sync_steps (int)</code>:ç¡®å®šå½“å‰ç­–ç•¥ä¸å‚è€ƒç­–ç•¥åŒæ­¥çš„é¢‘ç‡ï¼Œå•ä½ä¸ºæ­¥æ•°ã€‚é»˜è®¤å€¼ä¸º <code>512</code>ï¼Œæ­¤å‚æ•°å¿…é¡»ä¸ <code>sync_ref_model=True</code> ä¸€èµ·ä½¿ç”¨ã€‚</li></ul><h2 id="å¤§è§„æ¨¡grpoåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè®­ç»ƒ-70b-æ¨¡å‹">å¤§è§„æ¨¡GRPOï¼šåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè®­ç»ƒ 70B+ æ¨¡å‹</h2><p>åœ¨è®­ç»ƒ Qwen2.5-72B ç­‰å¤§å‹æ¨¡å‹æ—¶ï¼Œéœ€è¦è¿›è¡Œå‡ é¡¹å…³é”®ä¼˜åŒ–ï¼Œä»¥æé«˜è®­ç»ƒæ•ˆç‡å¹¶åœ¨å¤šä¸ª GPU å’ŒèŠ‚ç‚¹ä¹‹é—´æ‰©å±•ã€‚åŒ…æ‹¬ï¼š ### DeepSpeed ZeRO ç¬¬ 3 é˜¶æ®µ åˆ©ç”¨<strong>æ•°æ®å¹¶è¡Œ</strong>æ€§ï¼Œåœ¨å¤šä¸ª GPU å’Œ CPU ä¹‹é—´åˆ†é…æ¨¡å‹çŠ¶æ€ï¼ˆæƒé‡ã€æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€ï¼‰</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://wenliuyi.github.io">Liuyi Wen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://wenliuyi.github.io/posts/ae5287f0.html">http://wenliuyi.github.io/posts/ae5287f0.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="http://wenliuyi.github.io" target="_blank">Liuyi Wen's Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/46623c6f.html" title="è¯¦è§£å˜åˆ†è‡ªç¼–ç å™¨"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">è¯¦è§£å˜åˆ†è‡ªç¼–ç å™¨</div></div><div class="info-2"><div class="info-item-1">VAE ä¿¡æ¯è®º ä¿¡æ¯é‡ \(I(x)=-\log{P(x)}\),æè¿°äº‹ä»¶xä¸­åŒ…å«çš„ä¿¡æ¯é‡ã€‚ ä¿¡æ¯ç†µ è®¾éšæœºå˜é‡X~p(X),åˆ™Xçš„ç†µè¢«å®šä¹‰ä¸ºï¼š \[ H(p)=\mathbb{E}_{X\sim p(X)}[-\log p(X)]. \] å½“Xä¸ºç¦»æ•£éšæœºå˜é‡æ—¶ï¼Œ \[ H(p)=-\sum_{i=1}^{n}p(x_i)\log p(x_i) \] ç†µçš„æ•°å­¦åŒ–ç†è§£ï¼š ç¼–ç éšæœºå˜é‡æ‰€éœ€çš„æœ€çŸ­å¹³å‡ç¼–ç é•¿åº¦ å³å¯¹äºæ›´å¤§æ¦‚ç‡çš„äº‹ä»¶ï¼Œé‡‡ç”¨æ›´çŸ­çš„ç¼–ç (åŒHuffmanç¼–ç æ€è·¯ä¸€è‡´)ã€‚ è¯æ˜ï¼š å‡è®¾ç¼–ç çš„å­—ç¬¦é›†å¤§å°ä¸º\(D\)ï¼Œè‹¥é‡‡ç”¨äºŒè¿›åˆ¶ç¼–ç ï¼Œåˆ™\(D=2\). å‡è®¾å­˜åœ¨éœ€è¦ç¼–ç çš„\(m\)ä¸ªäº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶çš„ç¼–ç é•¿åº¦ä¸º\(l_i\). æ ¹æ®ç¼–ç ç†è®ºä¸­çš„Kraftâ€“McMillan Inequalityï¼Œåœ¨ç»™å®šçš„ç å­—å­—é•¿ä¸‹èƒ½å¤ŸæˆåŠŸç¼–ç ï¼Œå½“ä¸”ä»…å½“: \[ \sum_{i=1}^{m}D^{-l_i}\leq 1. \] è½¬ä¸ºå¦‚ä¸‹ä¼˜åŒ–é—®é¢˜ï¼š \[ \min_{l_i}\sum_{i=1}^{m}p(x_i)l_i \] \[\sum_{i=1}^{m}D^{-l_i}\leq 1.\]...</div></div></div></a><a class="pagination-related" href="/posts/44ad5109.html" title="C++æ³›å‹ç®—æ³•"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">C++æ³›å‹ç®—æ³•</div></div><div class="info-2"><div class="info-item-1">æœ¬ç¯‡éš¶å±C++ Primerä¸­C++æ ‡å‡†åº“ä¸“é¢˜ï¼Œå½“å‰å…³æ³¨èŒƒå‹ç®—æ³•ã€‚ æ ‡å‡†åº“å®¹å™¨åªå®šä¹‰äº†å¾ˆå°‘çš„æ“ä½œï¼›å› æ­¤æä¾›äº†ä¸€ç»„èŒƒå‹ç®—æ³•ï¼Œå…¶ä¸­å¤§å¤šæ•°ç‹¬ç«‹äºç‰¹å®šçš„å®¹å™¨ï¼Œå…·å¤‡é€šç”¨æ€§ã€‚ èŒƒå‹ç®—æ³• æ¦‚è¿° å¤§å¤šæ•°ç®—æ³•åœ¨å¤´æ–‡ä»¶algorithmä¸­ï¼›å¤´æ–‡ä»¶numericä¸­å®šä¹‰äº†ä¸€ç»„æ•°å€¼èŒƒå‹ç®—æ³•ã€‚ èŒƒå‹ç®—æ³•æœ¬èº«ä¸ä¼šæ‰§è¡Œå®¹å™¨çš„æ“ä½œï¼›åªä¼šè¿è¡Œäºè¿­ä»£å™¨ä¹‹ä¸Šï¼Œæ‰§è¡Œè¿­ä»£å™¨çš„æ“ä½œã€‚ åªè¯»ç®—æ³• åªè¯»å–è¾“å…¥èŒƒå›´çš„å…ƒç´ ï¼Œä»ä¸æ”¹å˜å…ƒç´  find 12int val=42;auto result=find(vec.cbegin(), vec.cend(), val); findå‰ä¸¤ä¸ªå‚æ•°ï¼šè¡¨ç¤ºå…ƒç´ èŒƒå›´çš„è¿­ä»£å™¨ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šä¸€ä¸ªå€¼ã€‚å°†èŒƒå›´ä¸­æ¯ä¸ªå…ƒç´ ä¸ç»™å®šå€¼æ¯”è¾ƒï¼š è¿”å›æŒ‡å‘ç¬¬ä¸€ä¸ªç­‰äºç»™å®šå€¼å…ƒç´ çš„è¿­ä»£å™¨ï¼› è‹¥èŒƒå›´å†…æ— åŒ¹é…å…ƒç´ ï¼Œè¿”å›ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¡¨ç¤ºæœç´¢å¤±è´¥ã€‚ accumulate 1int sum=accumulate(vec.cbegin(), vec.cend(), 0);	// å°†sumè®¾ç½®ä¸ºï¼švecä¸­å…ƒç´ ä¹‹å’Œ ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šä¿å­˜å’Œçš„å¯¹è±¡ç±»å‹ï¼Œåœ¨è¯¥ç±»å‹ä¸Šå¿…é¡»å®šä¹‰äº†"+"è¿ç®—ç¬¦ 12// é”™è¯¯ï¼šconst...</div></div></div></a></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="/img/butterfly-icon.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">Liuyi Wen</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/WenLiuyi"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">The Journey Is the Reward.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#grop%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">GROPæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">è¦ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5critic%E4%BD%BF%E7%94%A8%E9%A2%84%E6%B5%8Bbaseline%E6%94%B9%E8%BF%9B%E5%A5%96%E5%8A%B1"><span class="toc-number">1.1.1.</span> <span class="toc-text">å¼•å…¥criticï¼šä½¿ç”¨é¢„æµ‹baselineæ”¹è¿›å¥–åŠ±</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%A3%81%E5%89%AA%E5%92%8C%E6%9C%80%E5%B0%8F%E5%80%BC%E6%93%8D%E4%BD%9C%E9%98%B2%E6%AD%A2%E8%BF%87%E5%BA%A6%E6%9B%B4%E6%96%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">æ·»åŠ è£å‰ªå’Œæœ€å°å€¼æ“ä½œï¼šé˜²æ­¢è¿‡åº¦æ›´æ–°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2%E4%BD%9C%E5%BC%8A%E5%92%8C%E6%9E%81%E7%AB%AF%E7%AD%96%E7%95%A5%E4%BD%BF%E7%94%A8kl%E6%95%A3%E5%BA%A6"><span class="toc-number">1.1.3.</span> <span class="toc-text">é˜²æ­¢ä½œå¼Šå’Œæç«¯ç­–ç•¥ï¼šä½¿ç”¨KLæ•£åº¦</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%AD%E7%BB%83%E5%99%A8vlmgrpotrainer"><span class="toc-number">2.</span> <span class="toc-text">è‡ªå®šä¹‰è®­ç»ƒå™¨VLMGRPOTrainer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.</span> <span class="toc-text">åˆå§‹åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">è®­ç»ƒè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A5%96%E5%8A%B1%E5%87%BD%E6%95%B0iou_reward"><span class="toc-number">3.0.1.</span> <span class="toc-text">å¥–åŠ±å‡½æ•°ï¼šiou_reward</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#qwen2vlmodule%E7%9A%84reward"><span class="toc-number">3.0.1.1.</span> <span class="toc-text">Qwen2VLModuleçš„reward</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#grpo-config%E5%8F%82%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">GRPO Configå‚æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.</span> <span class="toc-text">æ•°æ®é¢„å¤„ç†å‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%8A%A0%E9%80%9F%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0vllm"><span class="toc-number">4.2.</span> <span class="toc-text">ç”ŸæˆåŠ é€Ÿç›¸å…³å‚æ•°ï¼ˆvLLMï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%8E%A7%E5%88%B6%E5%8F%82%E6%95%B0"><span class="toc-number">4.3.</span> <span class="toc-text">è®­ç»ƒæ§åˆ¶å‚æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E8%A7%84%E6%A8%A1grpo%E5%9C%A8%E5%A4%9A%E4%B8%AA%E8%8A%82%E7%82%B9%E4%B8%8A%E8%AE%AD%E7%BB%83-70b-%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">å¤§è§„æ¨¡GRPOï¼šåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè®­ç»ƒ 70B+ æ¨¡å‹</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4e29148d.html" title="go-context">go-context</a><time datetime="2025-07-09T09:16:57.000Z" title="å‘è¡¨äº 2025-07-09 17:16:57">2025-07-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/1e6a04d4.html" title="Transformerç³»åˆ—ï¼š2. Attentionæœºåˆ¶ï¼ŒMHAï¼ŒMQAå’ŒGQA">Transformerç³»åˆ—ï¼š2. Attentionæœºåˆ¶ï¼ŒMHAï¼ŒMQAå’ŒGQA</a><time datetime="2025-06-29T07:47:26.000Z" title="å‘è¡¨äº 2025-06-29 15:47:26">2025-06-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42e930ef.html" title="Transformerç³»åˆ—ï¼š1. ä»RNNåˆ°Transformer">Transformerç³»åˆ—ï¼š1. ä»RNNåˆ°Transformer</a><time datetime="2025-05-13T10:27:28.000Z" title="å‘è¡¨äº 2025-05-13 18:27:28">2025-05-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/76aa9d6e.html" title="Transformerçš„KV Cache">Transformerçš„KV Cache</a><time datetime="2025-05-06T01:49:26.000Z" title="å‘è¡¨äº 2025-05-06 09:49:26">2025-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/2ac460b1.html" title="verlæ¡†æ¶ï¼š2. å¯¹æ¯”OpenRLHF+colocateæ€è·¯è§£æ">verlæ¡†æ¶ï¼š2. å¯¹æ¯”OpenRLHF+colocateæ€è·¯è§£æ</a><time datetime="2025-05-06T01:49:06.000Z" title="å‘è¡¨äº 2025-05-06 09:49:06">2025-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Liuyi Wen</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(()=>{const t=()=>{if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typesetPromise();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"all"},chtml:{scale:1.1},options:{enableMenu:!0,renderActions:{findScript:[10,t=>{for(const e of document.querySelectorAll('script[type^="math/tex"]')){const n=!!e.type.match(/; *mode=display/),a=new t.options.MathItem(e.textContent,t.inputJax[0],n),d=document.createTextNode("");e.parentNode.replaceChild(d,e),a.start={node:d,delim:"",n:0},a.end={node:d,delim:"",n:0},t.math.push(a)}},""]}}};const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js",t.id="MathJax-script",t.async=!0,document.head.appendChild(t)}};btf.addGlobalFn("encrypt",t,"mathjax"),window.pjax?t():window.addEventListener("load",t)})()</script><script>(()=>{const n="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,e=(e,o)=>{n&&(window.shuoshuoComment.destroyValine=()=>{e.children.length&&(e.innerHTML="",e.classList.add("no-comment"))});const t={el:"#vcomment",appId:"bsxtUJWr1muoPS1pmoXLOPZ2-gzGzoHsz",appKey:"wm2wUYvKLEySwyRnFn7xAbJI",avatar:"monsterid",serverURLs:"",emojiMaps:"",visitor:!1,path:n?o:window.location.pathname};new Valine(t)},o=async(n,o)=>{"function"==typeof Valine||await btf.getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"),e(n,o)};n?window.shuoshuoComment={loadComment:o}:btf.loadComment(document.getElementById("vcomment"),o)})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body></html>